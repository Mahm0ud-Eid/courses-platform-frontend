<!DOCTYPE html>
<html lang="en">

<head>
  <title>Add New Post</title>
  <!-- META TAGS -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FAV ICON(BROWSER TAB ICON) -->
  <link rel="shortcut icon" href="images/uccd-logo.png" type="image/x-icon" />
  <!-- GOOGLE FONT -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CJosefin+Sans:600,700"
    rel="stylesheet" />
  <!-- FONTAWESOME ICONS -->
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

  <!-- ALL CSS FILES -->
  <link href="css/style.css" rel="stylesheet" />
  <!-- RESPONSIVE.CSS ONLY FOR MOBILE AND TABLET VIEWS -->
  <link href="css/style-mob.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/input-group.css" />

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet" />
  <link href="assets/css/file-upload.css" rel="stylesheet" />
  <link href="css/admin-responsive.css" rel="stylesheet" />
  <link href="css/post-management.css" rel="stylesheet" />
</head>

<body>
  <!-- MAIN CONTRAINER -->
  <header id="header" style="border-bottom: 2px solid #e3e8ea" class="header d d-flex align-items-center sticky-top">
    <img class="sd-tog" src="assets/img/side-bar.png" style="margin: 0 15px; width: 29px" alt="" />
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="index.html" class="logo d-flex align-items-center me-auto">
        <!-- <img src="images/uccd-logo.png" alt="" /> -->
        <h1 class="sitename">UCCD</h1>
      </a>

      <nav id="navmenu" class="navmenu navmenu-user">
        <ul>
          <li>
            <a class="logout-btn">
              <i class="bi bi-box-arrow-right"></i>
              <span>Log Out</span>
            </a>
          </li>
        </ul>
        <i class="mobile-nav-toggle bi bi-person-circle"></i>
      </nav>
    </div>
  </header>
  <!--== BODY CONTNAINER ==-->
  <div class="container-fluid sb2">
    <div class="row">
      <div class="sb2-1" style="background-color: white;">
        <!--== USER INFO ==-->
        <!-- <div class="sb2-12">
          <ul>
            <li><img src="images/placeholder.jpg" alt="" /></li>
            <li>
              <h5>Victoria Baker <span> Santa Ana, CA</span></h5>
            </li>
            <li></li>
          </ul>
        </div> -->
        <!--== LEFT MENU ==-->
        <div class="sb2-13">
          <ul class="collapsible" data-collapsible="accordion">
            <li>
              <a href="admin.html"><i class="fa fa-bar-chart" aria-hidden="true"></i>
                Dashboard</a>
            </li>

            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-book" aria-hidden="true"></i> All
                Courses</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-all-courses.html">All Course</a></li>
                  <li><a href="admin-add-courses.html">Add New Course</a></li>
                  <li><a href="admin-trash-courses.html">Trash Course</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-user" aria-hidden="true"></i>
                Instructors</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li>
                    <a class="inst-mg-btn" href="#">Manage</a>
                  </li>

                  <li><a class="inst-v-all" href="#">All Users</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header menu-active"><i class="fa fa-newspaper-o"
                  aria-hidden="true"></i>
                Posts</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-post-all.html">All Posts</a></li>
                  <li>
                    <a href="admin-post-add.html" class="menu-active">Create New Post</a>
                  </li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-users" aria-hidden="true"></i>
                Students</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-user-all.html">All Students</a></li>
                  <li><a href="admin-user-add.html">Add New Students</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-cloud-download"
                  aria-hidden="true"></i>
                Import & Export</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li>
                    <a href="admin-export-data.html">Export all datas</a>
                  </li>
                  <li>
                    <a href="admin-import-data.html">Import all datas</a>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!--== BODY INNER CONTAINER ==-->
      <div class="sb2-2"> <!--== breadcrumbs ==-->
        <div class="sb2-2-2">
          <ul>
            <li>
              <a href=" index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a>
            </li>
            <li class="active-bre"><a href="#"> Add New Post</a></li>
            <li class="page-back">
              <a href="admin-post-all.html"><i class="fa fa-backward" aria-hidden="true"></i> Back</a>
            </li>
          </ul>
        </div>

        <!--== User Details ==-->
        <div class="sb2-2-3">
          <div class="row">
            <div class="col-md-12">
              <div class="box-inn-sp">
                <div class="inn-title">
                  <h4>Create New Post</h4>
                  <p>
                    Create a new post, announcement, or course notification
                  </p>
                </div>
                <div class="tab-inn">
                  <div class="post-form-section mb-4">
                    <form id="postForm">
                      <div class="row mb-3">
                        <div class="col-md-12">
                          <label for="postContent" class="form-label">Post Content <span
                              class="text-danger">*</span></label>
                          <textarea class="form-control" id="postContent" rows="8" placeholder="Enter post content"
                            required></textarea>
                          <div class="invalid-feedback">
                            Please enter post content.
                          </div>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-12">
                          <label for="featuredImage" class="form-label">Featured Image (Optional)</label>
                          <input class="form-control" type="file" id="featuredImage" accept="image/*">
                          <div class="form-text">Recommended image size: 1200 x 630 pixels (16:9 ratio)</div>
                          <div class="mt-2">
                            <img id="imagePreview" src="" alt="Image Preview"
                              style="max-width: 300px; max-height: 200px; display: none;" class="img-thumbnail">
                          </div>
                        </div>
                      </div>
                      <div class="row mt-4">
                        <div class="col-md-12 text-end">
                          <button type="button" class="btn btn-secondary me-2"
                            onclick="window.location.href='admin-post-all.html'">Cancel</button>
                          <button type="submit" id="submitButton" class="btn btn-primary">Publish Post</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--Import jQuery before materialize.js-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="js/main.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="assets/js/sidebar-tog.js"></script>
  <script src="js/sidebar-init.js"></script>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Main JS File -->
  <script src="js/image-upload.js"></script>
  <script src="js/main.js"></script>
  <script src="js/manager.js"></script>
  <script src="js/logout.js"></script>
  <script src="js/post-management.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"; import {
      getFirestore,
      collection,
      addDoc,
      doc,
      updateDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCaUETFsFnRgSmNFIwEgyGWugfrK9zHbM0",
      authDomain: "uccd-f607e.firebaseapp.com",
      projectId: "uccd-f607e",
      storageBucket: "uccd-f607e.firebasestorage.app",
      messagingSenderId: "1037776187244",
      appId: "1:1037776187244:web:7d02b5edc4908dad390d49",
      measurementId: "G-B95Y1W5QWP",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // Current user information
    let currentUser = null;    // Check authentication state when the page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Show loading state
      const submitButton = document.getElementById('submitButton');
      const originalButtonText = submitButton.textContent;

      // Add form submission handler
      document.getElementById('postForm').addEventListener('submit', handleFormSubmit);

      // Add image preview functionality
      const imageInput = document.getElementById('featuredImage');
      const imagePreview = document.getElementById('imagePreview');

      imageInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();

          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
          };

          reader.readAsDataURL(this.files[0]);
        } else {
          imagePreview.style.display = 'none';
        }
      });
      // Check if user is logged in
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in
          currentUser = user;
          console.log("User is signed in:", user.email);

          // Get user information from Firestore if needed
          try {
            // We can retrieve additional user data from Firestore
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (userDoc.exists()) {
              // Add user data to currentUser object
              currentUser.userData = userDoc.data();
              console.log("User data retrieved:", currentUser.userData);
            } else {
              console.log("No user document found in Firestore");
            }
          } catch (error) {
            console.warn("Error getting user data:", error);
          }
        } else {
          // User is signed out, redirect to login
          console.log("No user is signed in");
          window.location.href = "login.html";
        }
      });
    }); async function handleFormSubmit(event) {
      event.preventDefault();

      // Get form elements
      const postContent = document.getElementById('postContent').value.trim();
      const featuredImageInput = document.getElementById('featuredImage');
      const submitButton = document.getElementById('submitButton');

      // Form validation with visual feedback
      let isValid = true;

      if (!postContent) {
        document.getElementById('postContent').classList.add('is-invalid');
        isValid = false;
      } else {
        document.getElementById('postContent').classList.remove('is-invalid');
      }

      if (!isValid) {
        return;
      }

      // Validate image if provided
      if (featuredImageInput.files.length > 0) {
        const file = featuredImageInput.files[0];
        // Check if file is an image
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file');
          return;
        }

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image size should be less than 5MB');
          return;
        }
      }

      // Show loading state
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publishing...</span>'; try {
        // Check if user is logged in
        if (!currentUser) {
          alert('You must be logged in to create a post');
          window.location.href = 'login.html';
          return;
        }
        // Get the publisher name from the user's data
        let publisherName;

        // Check if we have user data from Firestore
        if (currentUser.userData && currentUser.userData.name) {
          publisherName = currentUser.userData.name;
        }
        // Try display name from auth
        else if (currentUser.displayName) {
          publisherName = currentUser.displayName;
        }
        // If we have a name in the provider data, use that
        else if (currentUser.providerData &&
          currentUser.providerData[0] &&
          currentUser.providerData[0].displayName) {
          publisherName = currentUser.providerData[0].displayName;
        }
        // Finally, fall back to email if we have nothing else
        else {
          publisherName = currentUser.email.split('@')[0];
          publisherName = publisherName.charAt(0).toUpperCase() +
            publisherName.slice(1).replace(/[._]/g, ' ');
        }
        // Generate default image URL for users without a profile photo
        let publisherImage = '';
        if (currentUser.photoURL) {
          // Use the user's actual profile photo if available
          publisherImage = currentUser.photoURL;
        } else {
          // Get the first character of the name for the profile initial
          const initial = publisherName.charAt(0).toUpperCase();
          // Create a data URL for a simple SVG with the initial
          const colors = [
            '#F44336', '#E91E63', '#9C27B0', '#673AB7',
            '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4',
            '#009688', '#4CAF50', '#8BC34A', '#CDDC39'
          ];
          // Generate a consistent color based on the initial
          const colorIndex = initial.charCodeAt(0) % colors.length;
          const bgColor = colors[colorIndex];

          // Create SVG with the initial
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="50" fill="${bgColor}" />
            <text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em" fill="white" font-family="Arial, sans-serif">${initial}</text>
          </svg>`;

          // Convert SVG to data URL
          publisherImage = 'data:image/svg+xml;base64,' + btoa(svg);
        }

        // Initialize post data
        const postData = {
          publisherName: publisherName,
          publisherEmail: currentUser.email,
          publisherImage: publisherImage,
          postDescription: postContent,
          likesCount: 0,
          commentsCount: 0,
          publishedAt: serverTimestamp()
        };

        // Handle image upload if present
        if (featuredImageInput.files.length > 0) {
          const imageFile = featuredImageInput.files[0];
          const imageExtension = imageFile.name.split('.').pop();
          const imageName = `post_${Date.now()}.${imageExtension}`;
          const storageRef = ref(storage, `posts/${imageName}`);

          // Upload image to Firebase Storage
          const uploadTask = await uploadBytes(storageRef, imageFile);
          console.log('Image uploaded successfully');

          // Get download URL
          const downloadURL = await getDownloadURL(uploadTask.ref);

          // Add image details to post data
          postData.postImageLink = downloadURL;
          postData.postImageName = imageName;
        }
        // Add document to Firestore
        const docRef = await addDoc(collection(db, "posts"), postData);
        console.log("Post added with ID:", docRef.id);

        // Update the post with its ID using the Firestore document ID
        const postRef = doc(db, "posts", docRef.id);
        await updateDoc(postRef, {
          postID: docRef.id
        });

        // Show success message
        alert('Post published successfully!');

        // Redirect to all posts page
        window.location.href = 'admin-post-all.html';

      } catch (error) {
        console.error("Error adding post:", error);
        alert(`Error publishing post: ${error.message}`);

        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = 'Publish Post';
      }
    }
  </script>
</body>

</html>