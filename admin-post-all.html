<!DOCTYPE html>
<html lang="en">

<head>
  <title>Admin Posts</title>
  <!-- META TAGS -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FAV ICON(BROWSER TAB ICON) -->
  <link rel="shortcut icon" href="images/uccd-logo.png" type="image/x-icon" />
  <!-- GOOGLE FONT -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CJosefin+Sans:600,700"
    rel="stylesheet" />
  <!-- FONTAWESOME ICONS -->
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

  <!-- ALL CSS FILES -->
  <link href="css/style.css" rel="stylesheet" />
  <!-- RESPONSIVE.CSS ONLY FOR MOBILE AND TABLET VIEWS -->
  <link href="css/style-mob.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/input-group.css" />

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet" />
  <link href="assets/css/file-upload.css" rel="stylesheet" />
  <link href="css/admin-responsive.css" rel="stylesheet" />
  <link href="css/post-management.css" rel="stylesheet" />

  <!-- Custom Styles for Table Alignment -->
  <style>
    .table th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 14px;
    }

    .table td,
    .table th {
      padding: 12px 15px;
      vertical-align: middle;
    }

    .table th:first-child,
    .table td:first-child {
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <!-- MAIN CONTRAINER -->
  <header id="header" style="border-bottom: 2px solid #e3e8ea" class="header d d-flex align-items-center sticky-top">
    <img class="sd-tog" src="assets/img/side-bar.png" style="margin: 0 15px; width: 29px" alt="" />
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="index.html" class="logo d-flex align-items-center me-auto">
        <!-- <img src="images/uccd-logo.png" alt="" /> -->
        <h1 class="sitename">UCCD</h1>
      </a>

      <nav id="navmenu" class="navmenu navmenu-user">
        <ul>
          <li>
            <a class="logout-btn">
              <i class="bi bi-box-arrow-right"></i>
              <span>Log Out</span>
            </a>
          </li>
        </ul>
        <i class="mobile-nav-toggle bi bi-person-circle"></i>
      </nav>
    </div>
  </header>
  <!--== BODY CONTNAINER ==-->
  <div class="container-fluid sb2">
    <div class="row">
      <div class="sb2-1" style="background-color: white;">
        <!--== USER INFO ==-->
        <!-- <div class="sb2-12">
          <ul>
            <li><img src="images/placeholder.jpg" alt="" /></li>
            <li>
              <h5>Victoria Baker <span> Santa Ana, CA</span></h5>
            </li>
            <li></li>
          </ul>
        </div> -->
        <!--== LEFT MENU ==-->
        <div class="sb2-13">
          <ul class="collapsible" data-collapsible="accordion">
            <li> <a href="admin.html"><i class="fa fa-bar-chart" aria-hidden="true"></i>
                Dashboard</a>
            </li>

            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-book" aria-hidden="true"></i> All
                Courses</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-all-courses.html">All Course</a></li>
                  <li><a href="admin-add-courses.html">Add New Course</a></li>
                  <li><a href="admin-trash-courses.html">Trash Course</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-user" aria-hidden="true"></i>
                Instructors</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li>
                    <a class="inst-mg-btn" href="#">Manage</a>
                  </li>

                  <li><a class="inst-v-all" href="#">All Users</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header menu-active"><i class="fa fa-newspaper-o"
                  aria-hidden="true"></i>
                Posts</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-post-all.html" class="menu-active">All Posts</a></li>
                  <li>
                    <a href="admin-post-add.html">Create New Post</a>
                  </li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-users" aria-hidden="true"></i>
                Students</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li><a href="admin-user-all.html">All Students</a></li>
                  <li><a href="admin-user-add.html">Add New Students</a></li>
                </ul>
              </div>
            </li>
            <li>
              <a href="javascript:void(0)" class="collapsible-header"><i class="fa fa-cloud-download"
                  aria-hidden="true"></i>
                Import & Export</a>
              <div class="collapsible-body left-sub-menu">
                <ul>
                  <li>
                    <a href="admin-export-data.html">Export all datas</a>
                  </li>
                  <li>
                    <a href="admin-import-data.html">Import all datas</a>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <!--== BODY INNER CONTAINER ==-->
      <div class="sb2-2">
        <!--== breadcrumbs ==-->
        <div class="sb2-2-2">
          <ul>
            <li>
              <a href=" index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a>
            </li>
            <li class="active-bre"><a href="#"> Posts</a></li>
            <li class="page-back">
              <a href=" index.html"><i class="fa fa-backward" aria-hidden="true"></i> Back</a>
            </li>
          </ul>
        </div>

        <!--== User Details ==-->
        <div class="sb2-2-3">
          <div class="row">
            <div class="col-md-12">
              <div class="box-inn-sp">
                <div class="inn-title">
                  <h4>All Posts</h4>
                  <p>
                    Manage your blog posts, announcements, and news articles
                  </p>
                </div>
                <div class="tab-inn">
                  <!-- Search and Filter Section -->
                  <div class="post-filter-section mb-4">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <div class="input-group"> <input type="text" class="form-control" id="searchInput"
                            placeholder="Search by post description..." aria-label="Search posts">
                          <button class="btn btn-primary" id="searchBtn" type="button">
                            <i class="fa fa-search"></i> Search
                          </button>
                        </div>
                      </div>

                    </div>
                    <div class="row">
                      <div class="col-12 text-end">
                        <a href="admin-post-add.html" class="btn btn-success">
                          <i class="fa fa-plus"></i> Add New Post
                        </a>
                      </div>
                    </div>
                  </div>
                  <!-- End Search and Filter Section -->
                  <div class="table-responsive table-desi">
                    <table class="table table-hover" data-no-checkboxes="true">
                      <thead>
                        <tr>
                          <th>DESCRIPTION</th>
                          <th>PUBLISHER</th>
                          <th>PUBLISHED DATE</th>
                          <th>ACTIONS</th>
                        </tr>
                      </thead>
                      <tbody id="postsTableBody"> <!-- Will be populated from Firebase -->
                        <!-- Posts will be loaded from Firebase -->
                        <tr>
                          <td colspan="4" class="text-center">Loading posts from Firebase...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Pagination and Bulk Actions -->
                  <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                      <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-end">
                          <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                          </li>
                          <li class="page-item active"><a class="page-link" href="#">1</a></li>
                          <li class="page-item"><a class="page-link" href="#">2</a></li>
                          <li class="page-item"><a class="page-link" href="#">3</a></li>
                          <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                          </li>
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> <!--Import jQuery before materialize.js-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="js/main.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="assets/js/sidebar-tog.js"></script>
  <script src="js/sidebar-init.js"></script>
  <script src="js/post-management.js"></script>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Firebase SDK -->
  <script type="module">    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      deleteDoc,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCaUETFsFnRgSmNFIwEgyGWugfrK9zHbM0",
      authDomain: "uccd-f607e.firebaseapp.com",
      projectId: "uccd-f607e",
      storageBucket: "uccd-f607e.firebasestorage.app",
      messagingSenderId: "1037776187244",
      appId: "1:1037776187244:web:7d02b5edc4908dad390d49",
      measurementId: "G-B95Y1W5QWP",
    };    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Fetch and display posts when the page loads
    document.addEventListener('DOMContentLoaded', async function () {
      await loadPosts();

      // Set up search functionality
      document.getElementById('searchBtn').addEventListener('click', performSearch);
      document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
      document.getElementById('searchInput').addEventListener('input', function () {
        if (this.value === '') {
          showAllPosts();
        }
      });
    });

    async function loadPosts() {
      try {
        const tableBody = document.getElementById('postsTableBody');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading posts...</td></tr>';

        // Create a query to get posts ordered by publishedAt (most recent first)
        const postsQuery = query(collection(db, "posts"), orderBy("publishedAt", "desc"));
        const querySnapshot = await getDocs(postsQuery);

        if (querySnapshot.empty) {
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No posts found</td></tr>';
          return;
        }

        let postsHTML = '';
        querySnapshot.forEach((doc) => {
          const postData = doc.data();
          const postId = doc.id;
          // Extract the fields we want
          const postDescription = postData.postDescription || postData.content || 'No description';

          // Get the publisher name
          const publisherName = postData.publisherName || postData.authorName || 'Anonymous';

          // Format the date from Firebase Timestamp
          let formattedDate = 'No date';
          if (postData.publishedAt) {
            if (typeof postData.publishedAt.toDate === 'function') {
              const date = postData.publishedAt.toDate();
              formattedDate = date.toLocaleString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              });
            } else if (typeof postData.publishedAt === 'string') {
              formattedDate = postData.publishedAt;
            }
          }          // Create table row for each post
          postsHTML += `
            <tr data-post-id="${postId}">
              <td>${postDescription}</td>
              <td>${publisherName}</td>
              <td>${formattedDate}</td>
              <td>
                <a href="admin-post-edit.html?id=${postId}" class="ad-st-view">Edit</a>
                <a href="#" class="ad-st-view bg-danger delete-post" data-post-id="${postId}" style="margin-left: 5px;">Delete</a>
              </td>
            </tr>
          `;
        });

        tableBody.innerHTML = postsHTML;

        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-post').forEach(button => {
          button.addEventListener('click', function (e) {
            e.preventDefault();
            const postId = this.getAttribute('data-post-id');
            if (confirm('Are you sure you want to delete this post?')) {
              deletePost(postId);
            }
          });
        });

      } catch (error) {
        console.error("Error loading posts:", error);
        document.getElementById('postsTableBody').innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-danger">
              Error loading posts: ${error.message}
            </td>
          </tr>
        `;
      }
    } async function deletePost(postId) {
      try {
        console.log(`Attempting to delete post: ${postId}`);

        // First, get the post data to check if it exists and has an image
        const postDocRef = doc(db, "posts", postId);
        const postDoc = await getDoc(postDocRef);

        if (!postDoc.exists()) {
          console.warn("Post document does not exist");
          alert('Post not found or already deleted');
          await loadPosts(); // Refresh the list
          return;
        }

        const postData = postDoc.data();
        console.log("Post data:", postData);

        // If the post has an image, try to delete it from Storage
        if (postData.postImageLink || postData.imageUrl) {
          try {
            const imageUrl = postData.postImageLink || postData.imageUrl;
            console.log("Attempting to delete image:", imageUrl);

            // Check if the URL is a full storage URL or a download URL
            if (imageUrl && imageUrl.startsWith('https://')) {
              // For download URLs, we need to extract the storage path
              // This is a simplified approach - may need adjustments based on your URL format
              const urlParts = imageUrl.split('?')[0]; // Remove query parameters
              const pathParts = urlParts.split('/o/')[1]; // Get the path after /o/

              if (pathParts) {
                const decodedPath = decodeURIComponent(pathParts);
                const imageRef = ref(storage, decodedPath);
                await deleteObject(imageRef);
              } else {
                // Try direct reference as fallback
                const imageRef = ref(storage, imageUrl);
                await deleteObject(imageRef);
              }
            } else {
              // If it's already a storage path
              const imageRef = ref(storage, imageUrl);
              await deleteObject(imageRef);
            }

            console.log("Image deleted successfully");
          } catch (storageError) {
            console.warn("Error deleting image (continuing with post deletion):", storageError);
            // Continue with document deletion even if image deletion fails
          }
        }

        // Delete the document from Firestore
        console.log("Deleting document from Firestore...");
        await deleteDoc(postDocRef);
        console.log("Document deleted successfully");

        // Remove the row from the UI
        const row = document.querySelector(`tr[data-post-id="${postId}"]`);
        if (row) {
          row.remove();
        }

        alert('Post deleted successfully');        // Reload posts to ensure the list is fresh
        console.log("Reloading posts...");
        await loadPosts();

      } catch (error) {
        console.error("Error deleting post:", error);
        alert(`Failed to delete post: ${error.message}\n\nCheck console for details.`);
      }
    } function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const rows = document.querySelectorAll('#postsTableBody tr');

      rows.forEach(row => {
        // Skip rows that don't have enough cells (like loading rows)
        if (!row.cells || row.cells.length < 3) return;

        const description = row.cells[0]?.textContent.toLowerCase() || '';

        if (searchTerm === '') {
          row.style.display = '';
        } else {
          // Split description into words and check if any word starts with the search term
          const words = description.split(/\s+/);
          const found = words.some(word => word.startsWith(searchTerm));

          if (found) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        }
      });
    }

    function showAllPosts() {
      const rows = document.querySelectorAll('#postsTableBody tr');
      rows.forEach(row => {
        row.style.display = '';
      });
    }
  </script>
  <!-- Main JS File -->
  <script src="js/image-upload.js"></script>
  <script src="js/main.js"></script>
  <script src="js/manager.js"></script>
  <script src="js/logout.js"></script>
</body>

</html>